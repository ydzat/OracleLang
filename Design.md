# OracleLang 插件设计说明

## 🧠 插件简介

**OracleLang** 是一个为 LangBot 平台开发的智能算卦插件。它结合《易经》原理与数学模型，通过用户的问题或输入生成卦象，并返回包含卦象图、计算过程与解释的完整结果。

本插件旨在实现以下功能：
- 基于用户输入的文本或问题，生成符合易经原理的卦象
- 提供专业的卦象解读，包括卦象图示、卦辞、爻辞和白话解释
- 支持多种起卦方式，如文本起卦、数字起卦和时间起卦
- 记录用户的历史问题和卦象，方便回顾与追踪
- 限制用户每日算卦次数，避免过度依赖

插件支持用户历史记录的保存与调用，未来可支持多种起卦算法（如数字起卦、时间起卦等），并将持续扩展解卦系统。

---

## 🔧 使用方式

在 LangBot 中安装插件后，用户可以使用以下命令格式：

### 基本命令

```
!算卦 [问题]
```

例如：
```
!算卦 工作
!算卦 我今天应该去面试吗
!算卦 明天的考试结果如何
```

### 高级命令

```
!算卦 [方式] [参数] [问题]
```

例如：
```
!算卦 数字 1234 关于我的事业发展
!算卦 时间 关于我的健康状况
!算卦 历史 查看我上次的卦象
```

### 管理命令（仅管理员可用）

```
!算卦 设置 次数 [数字]    # 设置每人每日算卦次数限制
!算卦 重置 [用户ID]      # 重置指定用户的当日算卦次数
!算卦 统计              # 查看算卦使用统计信息
```

LangBot 将调用 OracleLang 插件，并返回一卦（包括图示、解释与计算细节）。

---

## 📁 项目结构

```
/OracleLang/
├── main.py                # 主入口文件
├── config.py              # 配置项定义
├── config.yaml            # 用户配置文件（自动生成）
├── README.md              # 说明文档
├── requirements.txt       # 依赖库
├── src/                   # 源代码目录
│   ├── __init__.py
│   ├── calculator.py      # 卦象计算模块
│   ├── interpreter.py     # 解卦模块
│   ├── glyphs.py         # 卦象图形生成
│   ├── history.py        # 历史记录处理
│   └── limit.py          # 用户使用限制
└── data/                  # 数据存储目录
    ├── history/          # 用户历史记录
    │   └── [user_id].json
    ├── static/           # 静态数据
    │   └── hexagrams.json # 64卦数据
    └── limits/           # 用户限制数据
        └── daily_usage.json
```

## 🧱 模块结构

### 1. `main.py`

- **功能：**
  - 插件注册与 LangBot 接口入口
  - 命令解析：从用户输入中提取"问题"、"起卦方式"、"用户 ID"
  - 流程调度：调用各个模块实现完整的算卦流程
  - 结果格式化：将处理结果整合为用户友好的输出格式
  - 用户限制检查：通过 limit.py 检查用户当日使用次数

- **处理流程：**
  1. 解析用户输入
  2. 检查用户使用限制
  3. 根据参数调用 calculator 模块生成卦象
  4. 调用 glyphs 模块生成卦象图示
  5. 调用 interpreter 模块获取卦象解释
  6. 保存结果到历史记录
  7. 更新用户使用次数
  8. 组织并返回最终结果

---

### 2. `src/calculator.py`

- **功能：** 根据用户输入或随机数计算六爻，形成原卦与变卦
- **实现方法：**
  - 随机起卦：使用随机数生成器模拟传统的掷币方式
  - 文本起卦：根据输入文本的特征生成唯一的卦象
  - 数字起卦：根据用户提供的数字序列生成卦象
  - 时间起卦：根据当前时间生成卦象

- **输入参数：**
  ```python
  {
      "method": "random|text|number|time",
      "input": "用户输入的文本或数字",
      "user_id": "用户标识"
  }
  ```

- **输出结构：**
  ```python
  {
      "original": [1, 0, 1, 1, 0, 0],  # 六爻从下到上，1代表阳爻，0代表阴爻
      "changed":  [1, 1, 1, 1, 0, 0],  # 变卦
      "moving":   [0, 1, 0, 0, 0, 0],  # 动爻标记，1表示该爻为动爻
      "hexagram_original": 30,         # 原卦编号（1-64）
      "hexagram_changed": 1            # 变卦编号（1-64）
  }
  ```

### 3. `src/interpreter.py`

- **功能：** 根据卦象返回卦名、爻辞、吉凶等文字解释
- **数据源：**
  - 内置静态数据：从 `data/static/hexagrams.json` 读取64卦的卦名、卦象、卦辞和爻辞
  - 大语言模型API：可选使用API获取更个性化的解释（需在配置文件中设置）

- **输入参数：**
  ```python
  {
      "hexagram_original": 30,         # 原卦编号
      "hexagram_changed": 1,           # 变卦编号
      "moving": [0, 1, 0, 0, 0, 0],    # 动爻标记
      "question": "用户的原始问题",     # 用于大模型解释
      "use_llm": True                  # 是否使用大语言模型
  }
  ```

- **输出结构：**
  ```python
  {
      "original": {
          "name": "离为火",
          "gua_ci": "利贞，亨，畜牝牛，吉。",
          "description": "离卦表示光明、文明、附着...",
          "lines": ["初九：履错然，敬之无咎。", ...]
      },
      "changed": {
          "name": "乾为天",
          "gua_ci": "元亨利贞。",
          "description": "乾卦表示刚健、自强不息...",
          "lines": ["初九：潜龙勿用。", ...]
      },
      "moving_lines_meaning": ["九二：见龙在田，利见大人。", ...],
      "overall_meaning": "此卦象征变化与坚定，利于主动求变...",
      "fortune": "吉",
      "advice": "建议积极主动，把握机会..."
  }
  ```

### 4. `src/glyphs.py`

- **功能：** 将卦象数组渲染为图形或 Unicode
- **实现方式：** 
  - 通过映射将卦象数组转换为Unicode字符或ASCII艺术
  - 支持不同展示风格：简洁、传统或详细

- **输入参数：**
  ```python
  {
      "original": [1, 0, 1, 1, 0, 0],
      "changed": [1, 1, 1, 1, 0, 0],
      "moving": [0, 1, 0, 0, 0, 0],
      "style": "simple|traditional|detailed"
  }
  ```

- **输出形式：**
  ```
  简洁模式:
  ☲ → ☰
  
  传统模式:
  离（火） → 乾（天）
  
  详细模式:
  ━━━     ━━━     乾为天（变卦）
  ━ ━     ━━━     
  ━━━     ━━━     
  ━━━     ━━━     
  ━ ━     ━ ━     离为火（原卦）
  ━━━     ━━━     
  ```

### 5. `src/history.py`

- **功能：** 保存与读取用户历史记录
- **实现方式：**
  - 文件存储：每个用户一个JSON文件，保存在 `data/history/` 目录中
  - 内存缓存：优化频繁访问的性能
  - 数据清理：定期清理过期数据

- **数据结构：**
  ```python
  {
      "user_id": "用户ID",
      "records": [
          {
              "timestamp": "2023-10-20 15:30:45",
              "question": "工作",
              "hexagram_original": 30,
              "hexagram_changed": 1,
              "result_summary": "离卦变乾卦，工作上将有光明前景..."
          },
          // 更多记录...
      ]
  }
  ```

### 6. `src/limit.py`

- **功能：** 管理用户每日算卦次数限制
- **实现方式：**
  - 基于东八区时间（UTC+8）判断日期变更
  - 在 `data/limits/` 目录中记录用户使用情况
  - 支持管理员重置和调整限制

- **数据结构：**
  ```python
  {
      "last_reset": "2023-10-20",  # 上次重置日期
      "users": {
          "user_id_1": {
              "count": 2,         # 今日已使用次数
              "last_usage": "2023-10-20 15:30:45"
          },
          // 更多用户...
      }
  }
  ```

### 7. `config.py` 和 `config.yaml`

- **功能：** 管理插件配置选项
- **配置项：**
  ```yaml
  # 用户限制
  limit:
    daily_max: 3               # 每人每日最大算卦次数
    reset_hour: 0              # 重置时间点（东八区，0-23）
  
  # 大语言模型设置
  llm:
    enabled: false             # 是否启用大模型解释
    api_type: "openai"         # 大模型类型：openai, qianfan, azure
    api_key: ""                # API密钥
    api_base: ""               # API基础URL（可选）
    model: "gpt-3.5-turbo"     # 模型名称
  
  # 显示设置
  display:
    style: "detailed"          # 默认卦象显示风格：simple, traditional, detailed
    language: "zh"             # 解释语言：zh, en
  
  # 开发者选项
  debug: false                 # 是否输出调试信息
  ```

## 📊 数据流程

1. **用户输入** → `main.py`(命令解析)
2. `limit.py` 检查用户当日使用次数
3. `main.py` → `calculator.py`(生成卦象)
4. 卦象结果 → `glyphs.py`(生成图形) + `interpreter.py`(获取解释)
5. 所有结果 → `history.py`(保存记录)
6. `limit.py` 更新用户使用次数
7. 整合结果 → **返回用户**

## 🔮 核心算法

### 起卦算法

1. **随机起卦**
   - 模拟传统掷币：每爻随机生成0或1，三次为一爻
   - 确定动爻：特定组合（如三阳或三阴）形成动爻

2. **文本起卦**
   - 计算文本哈希值，得到唯一数字
   - 将哈希值转换为六爻排列

3. **数字起卦**
   - 将用户输入的数字或数字序列转换为六爻
   - 支持常见的数字占卜法则

### 卦象解析

- 通过查表将六爻数组映射到64卦中的具体一卦
- 根据动爻情况，确定变卦
- 根据原卦、变卦和动爻的组合，生成综合解释

### 使用限制算法

- 基于东八区时间（UTC+8）判断日期
- 每天0:00自动重置所有用户的使用次数
- 支持配置文件调整最大使用次数
- 提供管理员命令手动重置指定用户

## 🔌 大语言模型集成

插件支持通过配置接入第三方大语言模型API，用于提供更加个性化和详细的卦象解释：

1. **配置方法**
   - 在 `config.yaml` 中设置 API 类型、密钥和其他必要参数
   - 支持 OpenAI、百度千帆（Qianfan）和 Azure OpenAI 服务

2. **数据处理流程**
   - 基础解释总是使用本地静态数据
   - 如果启用了大语言模型，会额外请求个性化解释
   - 将基础数据与大模型输出合并后返回

3. **提示词设计**
   - 构建包含卦象、卦辞和用户问题的提示词
   - 限制解释长度，确保返回简洁有用的内容

4. **错误处理**
   - API 调用失败时自动降级使用本地数据
   - 记录错误并提示用户配置问题

## 🚀 扩展计划

1. **支持更多起卦方法**
   - 梅花易数
   - 六爻纳甲法
   - 奇门遁甲

2. **增强解释系统**
   - 优化大语言模型提示词
   - 添加历史事件参考和案例分析
   - 增加针对特定领域（如事业、健康、情感等）的解释模板

3. **用户体验优化**
   - 提供可视化卦象和图表
   - 支持定制个人偏好的解释风格
   - 增加卦象解释的详细程度选项

## 插件输出结构（返回给 LangBot）

```python
{
  "question": "工作",
  "hexagram": {
    "original": [1, 0, 1, 1, 0, 0],  # 原卦六爻
    "changed":  [1, 1, 1, 1, 0, 0],  # 变卦六爻
    "moving":   [0, 1, 0, 0, 0, 0],  # 动爻标记
    "unicode":  "☲ → ☰"              # Unicode表示
  },
  "names": {
    "original": "离为火",
    "changed": "乾为天"
  },
  "interpretation": {
    "summary": "此卦象征变化与坚定，利于主动求变。",
    "details": "...",
    "moving_lines": ["九二：见龙在田，利见大人。", ...],
    "advice": "当前工作环境有变动，建议积极应对..."
  },
  "visual": "详细的卦象ASCII艺术或文本表示",
  "usage": {
    "remaining": 2,  # 当日剩余次数
    "total": 3       # 每日总次数限制
  }
}
```

